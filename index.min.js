var EventEmitter,numeral,extend=function(t,e){function r(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;numeral=require("numeral"),EventEmitter=require("events").EventEmitter,angular.module("util.audio",[]).constant("Modernizr",Modernizr).config(function(t){return t.resourceUrlWhitelist(["self","filesystem:**","blob:**"])}).run(function(t){return t.put("templates/util.audio/recorder.html",'<button \n  class="button" \n  on-hold="model.start()"\n  on-release="model.stop()"\n  ng-if="Modernizr.getusermedia">\n  <i class="icon ion-mic-a"></i>\n</button>'),t.put("templates/util.audio/player.html",'<button class="button" ng-click="start()" style="vertical-align: middle">\n  <i class="icon ion-play"></i>\n</button>\n<span style="vertical-align: middle">\n  {{duration}}\n</span>')}).directive("utilAudioRecorder",function(){return{restict:"E",templateUrl:function(t,e){return e.templateUrl||"templates/util.audio/recorder.html"},controller:function(t,e,r){return t.model=e.recorder,t.Modernizr=r}}}).directive("utilAudioPlayer",function(){return{restrict:"E",scope:{src:"@"},templateUrl:function(t,e){return e.templateUrl||"templates/util.audio/player.html"},controller:function(t,e,r,n){return e.$observe("src",function(e,i){if(e!==i)return n.player.connect(e).then(function(e){return t.duration=numeral(e.buffer.duration).format("00:00")}).catch(r.error)}),t.start=function(){return n.player.start(e.src).catch(r.error)},t.stop=function(){return n.player.stop()}}}}).factory("audioService",function(t,e){var r,n,i;return i=require("Wad/build/wad.js"),r=function(e){function r(){this.context=new r.AudioContext}var n;return extend(r,e),r.AudioContext=window.AudioContext||webkitAudioContext,n=null,r.instance=function(){return null!=n?n:n=new r},r.prototype.connect=function(e){return t.get(e,{responseType:"arraybuffer"}).then(function(t){return function(e){return new Promise(function(r,n){return t.context.decodeAudioData(e.data,r,n)})}}(this)).then(function(t){return function(e){var r;return r=t.context.createBufferSource(),r.buffer=e,r}}(this))},r.prototype.start=function(t){return this.connect(t).then(function(t){return function(e){return e.connect(t.context.destination),e.start(),t.emit("start")}}(this))},r.prototype.stop=function(){var t;return null!=(t=this.source)&&t.stop(),this.emit("stop")},r}(EventEmitter),n=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}var r;return extend(e,t),r=null,e.instance=function(){return null!=r?r:r=new e},e.prototype.start=function(){return null==this.media&&(this.media=new i.Poly({recConfig:{workerPath:"lib/Wad/src/Recorderjs/recorderWorker.js"}})),("undefined"!=typeof Modernizr&&null!==Modernizr?Modernizr.getusermedia:void 0)&&(null==this.mic&&(this.mic=new i({source:"mic"})),this.media.add(this.mic)),this.media.rec.clear(),this.media.output.disconnect(this.media.destination),this.media.rec.record(),this.mic.play(),this.emit("start")},e.prototype.stop=function(){var t;return null!=(t=this.mic)&&t.stop(),this.media.rec.stop(),this.media.output.connect(this.media.destination),this.media.rec.exportWAV(function(t){return function(e){return e.name="audio.wav",e.lastModifiedDate=new Date,t.file=e,t.url&&URL.revokeObjectURL(t.url),t.url=URL.createObjectURL(t.file),t.emit("stop")}}(this))},e}(EventEmitter),{recorder:n.instance(),player:r.instance()}});