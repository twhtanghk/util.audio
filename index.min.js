var EventEmitter,extend=function(t,e){function r(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;EventEmitter=require("events").EventEmitter,angular.module("util.audio",[]).constant("Modernizr",Modernizr).config(function(t){return t.resourceUrlWhitelist(["self","filesystem:**","blob:**"])}).run(function(t){return t.put("templates/util.audio/recorder.html",'<button \n  class="button" \n  on-hold="model.start()"\n  on-release="model.stop()"\n  ng-if="Modernizr.getusermedia">\n  <i class="icon ion-mic-a"></i>\n</button>'),t.put("templates/util.audio/player.html",'<button class="button" ng-click="start()" style="vertical-align: middle">\n  <i class="icon ion-play"></i>\n</button>\n<span style="vertical-align: middle">\n  {{numeral(model.source.buffer.duration).format(\'00:00\')}}\n  {{model.source.buffer.paused}}\n</span>')}).directive("utilAudioRecorder",function(){return{restict:"E",templateUrl:function(t,e){return e.templateUrl||"templates/util.audio/recorder.html"},controller:function(t,e,r){return t.model=e.recorder,t.Modernizr=r}}}).directive("utilAudioPlayer",function(){return{restrict:"E",scope:{src:"@"},templateUrl:function(t,e){return e.templateUrl||"templates/util.audio/player.html"},controller:function(t,e,r){return t.model=new r.Player,t.numeral=require("numeral"),e.$observe("src",function(e,r){if(e!==r)return t.model.connect(e)}),t.start=function(){return t.model.start()},t.stop=function(){return t.model.stop()}}}}).factory("audioService",function(t,e){var r,n,o;return o=require("Wad/build/wad.js"),r=function(e){function r(){this.context=new r.AudioContext}var n;return extend(r,e),r.AudioContext=window.AudioContext||webkitAudioContext,n=null,r.instance=function(){return null!=n?n:n=new r},r.prototype.connect=function(e){return this.url=e,t.get(this.url,{responseType:"arraybuffer"}).then(function(t){return function(e){return new Promise(function(r,n){return t.context.decodeAudioData(e.data,function(t){return r(t)})})}}(this)).then(function(t){return function(e){return t.source=t.context.createBufferSource(),t.source.buffer=e,t.source.connect(t.context.destination)}}(this))},r.prototype.start=function(){return this.connect(this.url).then(function(t){return function(){var e;return null!=(e=t.source)&&e.start(),t.emit("start")}}(this)),this},r.prototype.stop=function(){var t;return null!=(t=this.source)&&t.stop(),this.emit("stop"),this},r}(EventEmitter),n=function(t){function r(){return this.media=new o.Poly({recConfig:{workerPath:"lib/Wad/src/Recorderjs/recorderWorker.js"}}),("undefined"!=typeof Modernizr&&null!==Modernizr?Modernizr.getusermedia:void 0)?(this.mic=new o({source:"mic"}),void this.media.add(this.mic)):void e.error("getusermedia not supported")}var n;return extend(r,t),n=null,r.instance=function(){return null!=n?n:n=new r},r.prototype.start=function(){return this.media.rec.clear(),this.media.output.disconnect(this.media.destination),this.media.rec.record(),this.mic.play(),this.emit("start"),this},r.prototype.stop=function(){var t;return null!=(t=this.mic)&&t.stop(),this.media.rec.stop(),this.media.output.connect(this.media.destination),this.media.rec.exportWAV(function(t){return function(e){return e.name="audio.wav",e.lastModifiedDate=new Date,t.file=e,t.url&&URL.revokeObjectURL(t.url),t.url=URL.createObjectURL(t.file),t.emit("stop")}}(this)),this},r}(EventEmitter),{recorder:n.instance(),Player:r}});