var EventEmitter,numeral,extend=function(t,e){function n(){this.constructor=t}for(var r in e)hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;numeral=require("numeral"),EventEmitter=require("events").EventEmitter,angular.module("util.audio",[]).constant("Modernizr",Modernizr).config(function(t){return t.resourceUrlWhitelist(["self","filesystem:**","blob:**"])}).run(function(t){return t.put("templates/util.audio/recorder.html",'<button \n  class="button" \n  on-hold="model.start()"\n  on-release="model.stop()"\n  ng-if="Modernizr.getusermedia">\n  <i class="icon ion-mic-a"></i>\n</button>'),t.put("templates/util.audio/player.html",'<button class="button" ng-click="start()" style="vertical-align: middle">\n  <i class="icon ion-play"></i>\n</button>\n<span style="vertical-align: middle">\n  {{duration}}\n</span>')}).directive("utilAudioRecorder",function(){return{restict:"E",templateUrl:function(t,e){return e.templateUrl||"templates/util.audio/recorder.html"},controller:function(t,e,n){return t.model=e.recorder,t.Modernizr=n}}}).directive("utilAudioPlayer",function(){return{restrict:"E",scope:{src:"@"},templateUrl:function(t,e){return e.templateUrl||"templates/util.audio/player.html"},controller:function(t,e,n,r){return e.$observe("src",function(e,i){if(e!==i)return r.player.connect(e).then(function(e){return t.duration=numeral(e.buffer.duration).format("00:00")}).catch(n.error)}),t.start=function(){return r.player.start(e.src).catch(n.error)},t.stop=function(){return r.player.stop()}}}}).factory("audioService",function(t,e){var n,r,i;return i=require("Wad/build/wad.js"),n=function(e){function n(){this.context=new n.AudioContext}var r;return extend(n,e),n.AudioContext=window.AudioContext||webkitAudioContext,r=null,n.instance=function(){return null!=r?r:r=new n},n.prototype.connect=function(e){return t.get(e,{responseType:"arraybuffer"}).then(function(t){return function(e){return new Promise(function(n,r){return t.context.decodeAudioData(e.data,n,r)})}}(this)).then(function(t){return function(e){var n;return n=t.context.createBufferSource(),n.buffer=e,n}}(this))},n.prototype.start=function(t){return this.connect(t).then(function(t){return function(e){return e.connect(t.context.destination),e.start(),t.emit("start")}}(this))},n.prototype.stop=function(){var t;return null!=(t=this.source)&&t.stop(),this.emit("stop")},n}(EventEmitter),r=function(t){function e(){this.media=new i.Poly({recConfig:{workerPath:"lib/Wad/src/Recorderjs/recorderWorker.js"}}),("undefined"!=typeof Modernizr&&null!==Modernizr?Modernizr.getusermedia:void 0)&&(this.mic=new i({source:"mic"}),this.media.add(this.mic))}var n;return extend(e,t),n=null,e.instance=function(){return null!=n?n:n=new e},e.prototype.start=function(){return this.media.rec.clear(),this.media.output.disconnect(this.media.destination),this.media.rec.record(),this.mic.play(),this.emit("start")},e.prototype.stop=function(){var t;return null!=(t=this.mic)&&t.stop(),this.media.rec.stop(),this.media.output.connect(this.media.destination),this.media.rec.exportWAV(function(t){return function(e){return e.name="audio.wav",e.lastModifiedDate=new Date,t.file=e,t.url&&URL.revokeObjectURL(t.url),t.url=URL.createObjectURL(t.file),t.emit("stop")}}(this))},e}(EventEmitter),{recorder:r.instance(),player:n.instance()}});